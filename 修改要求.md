第三阶段：化繁为简 —— 智能报表（Views）
目标：老师提到了“视图对性能的影响分析”。虽然视图在 MySQL 中通常不提升性能（除非是物化视图，但 MySQL 原生不支持），但它能简化复杂查询并提供逻辑独立性。

我们将创建两个高级视图，直接服务于前端的“仪表盘”和“成绩单”页面。

1. SQL 实现 (添加到 init.sql)
SQL

-- 1. 班级成绩统计视图 (供教师端仪表盘使用)
-- 自动计算：平均分、最高分、最低分、及格率
CREATE OR REPLACE VIEW vw_class_performance AS
SELECT 
    c.id AS class_id,
    c.class_name,
    co.course_name,
    t.name AS teacher_name,
    COUNT(g.score) AS student_count,
    ROUND(AVG(g.score), 2) AS avg_score,
    MAX(g.score) AS max_score,
    MIN(g.score) AS min_score,
    -- 计算及格率 (假设 >= 60 及格)
    CONCAT(ROUND(SUM(CASE WHEN g.score >= 60 THEN 1 ELSE 0 END) / COUNT(g.score) * 100, 1), '%') AS pass_rate
FROM classes c
JOIN students s ON c.id = s.class_id
JOIN enrollments e ON s.id = e.student_id
JOIN courses co ON e.course_id = co.id
JOIN teachers t ON co.teacher_id = t.id
JOIN grades g ON e.id = g.enrollment_id
GROUP BY c.id, c.class_name, co.course_name, t.name;

-- 2. 学生个人完整档案视图 (供学生端/导出使用)
-- 将分散在 User, Student, Class, Parent 表的信息聚合
CREATE OR REPLACE VIEW vw_student_full_profile AS
SELECT 
    s.id AS student_id,
    s.student_id AS code,   -- 学号
    s.name AS student_name,
    s.gender,
    c.class_name,
    u.username AS login_account,
    -- 聚合家长信息 (如果有多个家长，用逗号连接)
    GROUP_CONCAT(CONCAT(p.relation, ':', p.name, '(', p.phone, ')') SEPARATOR '; ') AS parents_info
FROM students s
LEFT JOIN classes c ON s.class_id = c.id
LEFT JOIN users u ON s.user_id = u.id
LEFT JOIN parents p ON s.id = p.student_id
GROUP BY s.id, s.student_id, s.name, s.gender, c.class_name, u.username;
2. Go 后端适配 (Gorm)
在 Go 中，你不需要为视图写复杂的 Join，直接把它当成一张只读表来查询。

在 backend/internal/models/view_models.go (新建文件) 中定义结构体：

Go

package models

// 对应 vw_class_performance 视图
type ClassPerformanceView struct {
    ClassID      uint    `json:"class_id" gorm:"column:class_id"`
    ClassName    string  `json:"class_name" gorm:"column:class_name"`
    CourseName   string  `json:"course_name" gorm:"column:course_name"`
    TeacherName  string  `json:"teacher_name" gorm:"column:teacher_name"`
    StudentCount int     `json:"student_count" gorm:"column:student_count"`
    AvgScore     float64 `json:"avg_score" gorm:"column:avg_score"`
    PassRate     string  `json:"pass_rate" gorm:"column:pass_rate"`
}

// 设定表名为视图名
func (ClassPerformanceView) TableName() string {
    return "vw_class_performance"
}
Controller 调用示例：

Go

// 获取某位老师的班级统计
db.Where("teacher_name = ?", teacherName).Find(&stats)
这就把原本要在 Go 里写的一大堆 Joins().Select().Group() 逻辑彻底消除了，代码极其清爽。